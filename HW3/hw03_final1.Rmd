---
title: "Home Work Assignment - 03"
author: "Critical Thinking Group 5"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

\newpage

# Overview 

The data set contains approximately 466 records and 14 variables. Each record has information on crime for various neighborhoods of a major city. Each record has a response variable indicating whether or not the crime rate is above the median crime rate (1) or not (0).

The objective is to build a binary logistic regression model on the training data set to predict whether the neighborhood will be at risk for high crime levels. In addition, we will provide classifications and probabilities for the evaluation data set using the binary logistic regression model. 

#1 Data Exploration Analysis

In section we will explore and gain some insights into the dataset by pursuing the below high level steps and inquiries: \
-Variable identification \
-Variable Relationships \
-Data summary analysis \
-Outliers and Missing Values Identification


##1.1	Variable identification

First let's display and examine the data dictionary or the data columns as shown in table 1

```{r, echo = FALSE, warning=FALSE, message=FALSE}
if (!require("ggplot2",character.only = TRUE)) (install.packages("ggplot2",dep=TRUE))
if (!require("MASS",character.only = TRUE)) (install.packages("MASS",dep=TRUE))
if (!require("knitr",character.only = TRUE)) (install.packages("knitr",dep=TRUE))
if (!require("xtable",character.only = TRUE)) (install.packages("xtable",dep=TRUE))
if (!require("dplyr",character.only = TRUE)) (install.packages("dplyr",dep=TRUE))
if (!require("psych",character.only = TRUE)) (install.packages("psych",dep=TRUE))
if (!require("stringr",character.only = TRUE)) (install.packages("stringr",dep=TRUE))
#if (!require("car",character.only = TRUE)) (install.packages("car",dep=TRUE))
if (!require("faraway",character.only = TRUE)) (install.packages("faraway",dep=TRUE))

library(ggplot2)
library(MASS)
library(knitr)
library(xtable)
library(dplyr)
library(psych)
library(stringr)
#library(car)
library(faraway)
library(aod)
library(Rcpp)
library(leaps)
library(ISLR)
library(AUC)
library(ROCR)
library(Amelia)

city_crime_train_full <- read.csv("https://raw.githubusercontent.com/kishkp/data621-ctg5/master/HW3/crime-training-data.csv")

variables<- read.csv("https://raw.githubusercontent.com/kishkp/data621-ctg5/master/HW3/variables2.csv")
kable(variables, caption = "Variable Description") 




city_crime_test <- read.csv("https://raw.githubusercontent.com/kishkp/data621-ctg5/master/HW3/crime-evaluation-data.csv")

#str(city_crime_test)


```

We notice that all variables are numeric except for two variables: 
the response variable "target" which is binary and the  predictor variable "chas" which 
is a dummy binary variable indicating whether the suburb borders the Charles River (1) or not (0).

Based on the original dataset, our predictor input is made of 13 variables. And our response variable is one variable called target. 


##1.2 Variable Relationships \

The variables seem to not have any arithmetic relations.  In other words, there are no symmetricity or transitivity relationships between any two variable in the independent variable set.  
In addition, since this is Logistic Regression, we will be making the below assumptions on the variables:\newline
-The dependent variable need not to be normally distributed \
-Errors need to be independent but not normally distributed. \
- We will be using GLM and GLM does not assume a linear relationship between dependent and independent variables. However, it assumes a linear relationship between link function and independent variables in logit model. \
- Also does not use OLS (Ordinary Least Square) for parameter estimation. Instead, it uses maximum likelihood estimation (MLE) 





```{r split train data to train and validation, echo=FALSE, eval=TRUE}


smp_size <- floor(0.80 * nrow(city_crime_train_full))

## set the seed to make your partition reproductible
set.seed(123)

train_ind <- sample(seq_len(nrow(city_crime_train_full)), size = smp_size)

city_crime_train<- city_crime_train_full[train_ind, ]
train_test <- city_crime_train_full[-train_ind, ]

```
\

Two data set has been created city_crime_train (80% of train data), and train_test (20% of train data).\

In next step below relationship between the target variable and dependent variables is shown in three charts.


##1.2 Data Summary Analysis


In this section, we will create summary data to better understand the initial relationship variables have with our dependent variable using correlation, central tendency, and dispersion As shown in table 2.  

```{r, echo = FALSE, warning=FALSE, message=FALSE, results='hide'}
ds_stats <- psych::describe(city_crime_train, skew = TRUE, na.rm = TRUE)
#ds_stats
kable(ds_stats[1:7], caption= "Data Summary")
kable(ds_stats[8:13], caption= "Data Summary (Cont)")

fun1 <- function(a, y) cor(y, a)
x<-city_crime_train[,]
Correlation <- sapply(x, FUN = fun1, y=city_crime_train$target) 

#kable(data.frame(Correlation), caption = "Correlation between target and predictor variable")
```


Now we will produce the correlation table between the independent variables and the dependent variable

```{r, echo = FALSE, warning=FALSE, message=FALSE}
Correlation <- sort(Correlation, decreasing = TRUE)
kable(Correlation, caption = "Variable Correlation")

```


Correlation analysis suggests that there are strong positive and negative between the independent variables and the dependent variable.  For instance, we notice that there is a strong correlation of .73 between the concentration of nitrogen oxides and crime rate being above average.  We will need to perform more investigations about this correlation as it is not obvious the concentration of nitrogen oxides would results in high crime rate; perhaps it impacts the crime rate indirectly by impacting other independent variables that we may or may not have in our data set.  
In addition, we noticed that accessibility to radial highways also has a strong correlation with the crime rate being average average.  Again we will investigate such correlation. 
We also noticed that unit or house age, property tax, and non-retail businesses having a positive impact on the crime rate being above average.

It is also worth noting that that distances to five Boston employment centers, large residential lots, the proportion of blacks by town, median value of owner-occupied homes, and the average number of rooms per dwelling, all have negative correlation to the crime rate being above crime rate average. In other words, the closer people are to the five Boston employment centers, the more likely the crime rate will be below the crime average. 


##1.3	Outliers and Missing Values Identification

###1.3.1 Missing Values 
As per Table .3 below, we see that we have no missing values which is good thing as we don't have to carry out any imputation tasks.  


```{r, echo = FALSE, warning=FALSE, message=FALSE}
missings<- sapply(city_crime_train_full,function(x) sum(is.na(x)))
kable(missings, caption = "Missing Values")

#missmap(city_crime_train_full, main = "Missing values vs observed")

### finding unique values


### % break up of target variable 

#prop.table(table(city_crime_train_full$target))

```

Also, as per Table .4 below, we can confirm that our target variable is binary as expected.

```{r, echo = FALSE, warning=FALSE, message=FALSE}
uniques<- sapply(city_crime_train_full, function(x) length(unique(x)))
kable(uniques, caption = "Unique Values")

```


###1.3.2 Outliers identification 

In this section univariate analysis is being carried out and boxplots diagrams are being used to determine the outliers in variables and decide on whether to act on the outliers

```{r, echo = FALSE, warning=FALSE, message=FALSE}

library(ggplot2)
library(reshape2)
#
mdata<- select(city_crime_train, -(target))
mdata2 <- melt(mdata)
# Output the boxplot
p <- ggplot(data = mdata2, aes(x=variable, y=value)) + 
  geom_boxplot() + ggtitle("Outliers identification")
p + facet_wrap( ~ variable, scales="free", ncol=5)

```

From the "Outliers identification" plot above, we see that we have few outliers that we need to treat. 
We see that: zn (residential land zoned), rm (average number of rooms per dwelling), dis(weighted mean of distances to five Boston employment centers), black (the proportion of blacks by town),lstat (lower status of the population), and medv median value of owner-occupied homes in $1000s  all need to be trated

\newpage

##1.3.3 Analysis the link function \

In this section, we will investigate how our initial data aligns with a typical logistic model plot. 

Recall the Logistic Regression is part of a larger class of algorithms known as Generalized Linear Model (glm).  The fundamental equation of generalized linear model is:
$g(E(y)) = a+ Bx_1+B_2x_2+ B_3x_3+...$   
where, g() is the link function, E(y) is the expectation of target variable and $B_0 + B_1x_1 + B_2x_2+B_3x_3$ is the linear predictor ( $B_0,B_1,B_2, B_3$ to be predicted). The role of link function is to 'link' the expectation of y to linear predictor.

In logistic regression, we are only concerned about the probability of outcome dependent variable ( success or failure). As described above, g() is the link function. This function is established using two things: Probability of Success (p) and Probability of Failure (1-p).  p should meet following criteria:
It must always be positive (since p >= 0)
It must always be less than equals to 1 (since p <= 1).

Now let's investigate how our initial data model aligns with the above criteria. In other words, we will plot regression model plots for each variable and compare it to a typical logistic model plot:


```{r,  echo = FALSE, warning=FALSE, message=FALSE}
library(popbio)
par(mfrow=c(2,3))
logi.hist.plot(x$zn,x$target,logi.mod = 1, type="hist", boxp=FALSE,col="gray", mainlabel = "zn")
logi.hist.plot(x$indus, x$target,logi.mod = 1, type="hist",boxp=FALSE,col="gray", mainlabel = "indus")
logi.hist.plot(x$chas,x$target,logi.mod = 1,boxp=FALSE,type="hist",col="gray", mainlabel = "chas")
logi.hist.plot(x$nox, x$target,logi.mod = 1,type="hist",boxp=FALSE,col="gray", mainlabel = "nox")
logi.hist.plot(x$rm,x$target,logi.mod = 1,boxp=FALSE,type="hist",col="gray", mainlabel = "rm")
logi.hist.plot(x$age, x$target,logi.mod = 1,type="hist",boxp=FALSE,col="gray", mainlabel = "age")
logi.hist.plot(x$dis,x$target,logi.mod = 1,boxp=FALSE,type="hist",col="gray", mainlabel = "dis")
logi.hist.plot(x$rad, x$target,logi.mod = 1,type="hist",boxp=FALSE,col="gray", mainlabel = "rad")
logi.hist.plot(x$tax,x$target,logi.mod = 1,boxp=FALSE,type="hist",col="gray", mainlabel = "tax")
logi.hist.plot(x$ptratio, x$target,logi.mod = 1,type="hist",boxp=FALSE,col="gray", mainlabel = "ptratio")
logi.hist.plot(x$black,x$target,logi.mod = 1,boxp=FALSE,type="hist",col="gray", mainlabel = "black")
logi.hist.plot(x$lstat, x$target,logi.mod = 1,type="hist",boxp=FALSE,col="gray", mainlabel = "lstat")
logi.hist.plot(x$medv, x$target,logi.mod = 1,type="hist",boxp=FALSE,col="gray", mainlabel = "medv")

```

##Interpretation \

You can see clearly that the probability of crime being above average increases as we get closer to the "1" classification for the indus,nox,age,rad,tax,and lstat  variables. In the middle, the probability changes at the highest rate, while it tails off at each end in order to bound it between 0 and 1. \

You can see clearly that the probability of crime being above average decreases as we get closer to the "1" classification for the zn, dis,black, and mdev  variables. In the middle, the probability changes at the lowest rate. However, it does not tails off at each end for all of the variables.


*********************\

In this section univariate analysis is being caarried out and boxplots diagrams are being used to determine the outliers in variables and decide on whether to act on the outliers. Along with boxplot, Histrogram, Sin, Log,Sqrt,nth transformation diagrams are used to evaluate best transformation to handle outliers.\


```{r, echo = FALSE, warning=FALSE, message=FALSE}

show_charts <- function(x, ...) {
    
    par(mfrow=c(2,3))
    
    xlabel <- unlist(str_split(deparse(substitute(x)), pattern = "\\$"))[2]
    ylabel <- unlist(str_split(deparse(substitute(y)), pattern = "\\$"))[2]
    
    hist(x,main=xlabel)
    boxplot(x,main=xlabel)

    y<-log(x)
    boxplot(y,main='log transform')
    y<-sqrt(x)
    boxplot(y,main='sqrt transform')
    y<-sin(x)
    boxplot(y,main='sin transform')
    y<-(x)^(1/9)
    boxplot(y,main='ninth transform')
   
}

# attach file to R so that only variable can be called

attach(city_crime_train)

```

Analysis of variable zn:proportion of residential land zoned for large lots 

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.cap='zn Transformation'}
show_charts(zn)

```
For zn, we can see that there are large number of values with 0. ninth transformation seem better for this variable..(1)

\newpage
***Please note that we have created similar figures to figure 1 above for each remaining variable. 
However, we hid the remaining figures for ease of streamlining the report as they have similar shapes. However, we have drawn the below observations from each remaining figure. \



```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(indus)

```

For indus, we can see that there is a spike toward right side of he distribution. Looking at the sqrt transformation it appears that distribution is close to normal and having two peaks after transformation.  
\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(nox)

```
\
For nox, there is a long right tail.

\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(rm)


```

\
For rm, there are some outliers as we can see from box plot. This variable will need some transformation to handle the outliers.
\

```{r, echo = FALSE, warning=FALSE, message=FALSE,fig.show ='hide'}

show_charts(age)
```

age of the building variable is skewed heavily towards right side. We will need some transformation for this variable and looks sin transformation is best option for this case  
\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(dis)

```

For this variable dis, there are some outliers which needs transformation to handle those outliers. log transformation looks best suited for this scenario.
\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(rad)


```

For rad variable distribution is not uniform as seen from the chart and will need transformation.

\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(tax)


```

For tax variable is not uniformly distributed but there is no outlier for this variable.
\



```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(ptratio)

```

For pratio has right aligned peak but no outliers are there in data set.
\
\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(black)

```


\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(lstat)

```
The variable lstat has long right tail and lef skewed

\
\

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.show ='hide'}

show_charts(medv)

```



#2. Data Preparation 

Now that we have completed the preliminary analysis, we will be cleaning and consolidating data into one dataset for use in analysis and modeling. We will be puring the belwo steps as guidlines: \
- Outliers treatment \
- Missing values treatment \
- Data transformation \



##2.1 Outliers treatment

For outliers, we will create 2 sets of variables. 

The first set uses the capping method. In this method, we will replace all outliers that lie outside the 1.5 times of IQR limits. We will cap it by replacing those observations less than the lower limit with the value of 5th %ile and those that lie above the upper limit with the value of 95th %ile. 

Accordingly we create the following new variables while retaining the original variables. 

city_crime_train$tax\
city_crime_train$medv\
city_crime_train$lstat\


```{r, echo = FALSE, warning=FALSE, message=FALSE}
# function for removing outliers - http://r-statistics.co/Outlier-Treatment-With-R.html

treat_outliers <- function(x) {
qnt <- quantile(x, probs=c(.25, .75), na.rm = T)
caps <- quantile(x, probs=c(.05, .95), na.rm = T)
H <- 1.5 * IQR(x, na.rm = T)
x[x < (qnt[1] - H)] <- caps[1]
x[x > (qnt[2] + H)] <- caps[2]
 
return(x)
}

city_crime_train_mod<-city_crime_train
train_test_mod<-train_test

city_crime_train_mod$tax_new <- treat_outliers(city_crime_train$tax)
city_crime_train_mod$medv_new <- treat_outliers(city_crime_train$medv)
city_crime_train_mod$lstat_new <- treat_outliers(city_crime_train$lstat)


train_test_mod$tax_new <- treat_outliers(train_test$tax)
train_test_mod$medv_new <- treat_outliers(train_test$medv)
train_test_mod$lstat_new <- treat_outliers(train_test$lstat)

```


Lets see how the new variables look in boxplots.

```{r, echo = FALSE, warning=FALSE, message=FALSE}

par(mfrow=c(1,3))

boxplot(city_crime_train_mod$tax_new,main="tax_new")
boxplot(city_crime_train_mod$medv_new,main="medv_new")
boxplot(city_crime_train_mod$lstat_new,main="lstat_new")

```


In the second set, we will use the sin transformation and create the following variables:

city_crime_train_mod$rm_new\

city_crime_train_mod$dis_new\


```{r, echo = FALSE, warning=FALSE, message=FALSE}

city_crime_train_mod$rm_new<-sin(city_crime_train$rm)

city_crime_train_mod$dis_new<-sin(city_crime_train$dis)

train_test_mod$rm_new<-sin(train_test$rm)

train_test_mod$dis_new<-sin(train_test$dis)

```

```{r, echo = FALSE, warning=FALSE, message=FALSE}

par(mfrow=c(1,2))

#boxplot(city_crime_train_mod$rm_new,main="rm_new")
#boxplot(city_crime_train_mod$dis_new,main="dis_new")


```




##2.3 Tranformation for Variables

\

Following variables will need some transformation:

1. zn: proportion of residential land zoned for large lots (over 25000 square feet) (predictor variable) 
2. chas: a dummy var. for whether the suburb borders the Charles River (1) or not (0) (predictor variable) 
3. target: whether the crime rate is above the median crime rate (1) or not (0) (response variable) 

```{r, echo = FALSE, warning=FALSE, message=FALSE}

city_crime_train_mod$zn_new<-city_crime_train_mod$zn

city_crime_train_mod$zn_new [city_crime_train_mod$zn_new > 0] <- 1
city_crime_train_mod$zn_new [city_crime_train_mod$zn_new== 0] <- 0
#city_crime_train_mod$zn_new<-factor(city_crime_train_mod$zn_new)



train_test_mod$zn_new<-train_test$zn

train_test_mod$zn_new [train_test_mod$zn_new > 0] <- 1
train_test_mod$zn_new [train_test_mod$zn_new== 0] <- 0
#city_crime_train_mod$zn_new<-factor(train_test_mod$zn_new)

#city_crime_train$chas <-factor(city_crime_train$chas)

#city_crime_train$target<-factor(city_crime_train$target)

#city_crime_train_mod$chas <-factor(city_crime_train_mod$chas)

#city_crime_train_mod$target<-factor(city_crime_train_mod$target)



```



```{r, echo = FALSE, warning=FALSE, message=FALSE}


#Correlation <- cor(city_crime_train$rm_new,(as.numeric(city_crime_train$target)))

#Correlation <- cor(city_crime_train$dis_new,(as.numeric(city_crime_train$target)))



```

\
All new variables seem to have a positive correlation with wins. However, some of them do not seem to have a strong correlation. Lets see how they perform while modeling.


\newpage



#3 Build Models




\newpage

Below is a summary table showing models and their respective variables. \

```{r, echo = FALSE, warning=FALSE, message=FALSE}

modelvars <- read.csv("https://raw.githubusercontent.com/kishkp/data621-ctg5/master/HW1/ModelVars.csv")
kable(modelvars)

```

\newpage 

##3.1.1 Model One by using all given variable
In this model, we will be using the original variables.  We will create model and we will highlight the variables that being recommended using the AIC value. \

First we will produce the summary model as per below: 

```{r, echo = FALSE, warning=FALSE, message=FALSE}

model1 <- glm(target ~ ., data = city_crime_train, family = "binomial")

summary(model1)





#test<-(train_test$target==1)

#count(pre_train1>0.5==test)


```

Accuracy=0.9042553

###3.1.2 Model two- with backward step function with all given variables

```{r step for model 1}

stepmodel1<- step(model1, direction="backward")

pre_train1_step<-predict(stepmodel1,type="response",newdata=train_test)

table(pre_train1_step>0.5,train_test$target)



```
Accuracy=0.8723404



##3.1.3 Model three- model with transformed variables
In this model, we will be using the some transformed variables.  


First we will produce the summary model as per below: 

```{r, echo = FALSE, warning=FALSE, message=FALSE}

model2 <- glm(target ~ .-zn-rm-dis-tax-lstat-medv, data = city_crime_train_mod, family = "binomial")
summary(model2)

pre_train2<-predict(model2,type="response",newdata=train_test_mod)

test<-predict(model2,type="response")

table(pre_train2>0.5,train_test_mod$target)

#roc(test,city_crime_train$target)

# Accuracy


```

Accuracy=0.9042553


###3.1.4 Model with transformed variable and with with backward step function

```{r step for model 2}

stepmodel2<- step(model2, direction="backward")

pre_train2_step<-predict(stepmodel2,type="response",newdata=train_test_mod)

table(pre_train2_step>0.5,train_test_mod$target)

```

Accuracy= 0.893617

###3.1,5 Model three with Linear discrement analysis

```{r model with Linear Discrement analysis, eval=TRUE,echo=FALSE}


model3=lda(target~.,data=city_crime_train)


model3_predict_test<-data.frame(predict(model3,newdata=train_test))

model3_predict_test[1:5,]

table(model3_predict_test$class,train_test$target)

```

Accuracy=0.8297872


###3.1.6 Model with Linear discrement analysis with transformed data

```{r model with Linear Discrement analysis with modified data, eval=TRUE,echo=FALSE}


model3_mod=lda(target~.-zn-rm-dis-tax-lstat-medv,data=city_crime_train_mod)


model3_predict_test_mod<-data.frame(predict(model3,newdata=train_test_mod))



table(model3_predict_test_mod$class,train_test_mod$target)

```

Accuracy=0.7978723





#4 Model Selection 

In section we will further examine all six models.  We will apply a model selection strategy defined below to compare the models.
\


##4.1 Model selection strategy:

Following model selection strategy has been used for this assignment: 

(1) Compare accuracy of the models & confusion matrix
(2) Compare Precision,Sensitivity,Specificity,F1 score
(3) Compare AUC curve for the models

```{r model 1 performance,echo=FALSE}


#confusion matrix
pre_train1 <- predict(model1, newdata=train_test, type="response")
table(pre_train1>0.5,train_test$target)



#AUC
pred <- prediction(pre_train1, train_test$target)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
# I know, the following code is bizarre. Just go with it.
auc <- performance(pred, measure = "auc")
auc <- auc@y.values[[1]]

roc.data <- data.frame(fpr=unlist(perf@x.values),
                       tpr=unlist(perf@y.values),
                       model="GLM")
ggplot(roc.data, aes(x=fpr, ymin=0, ymax=tpr)) +
    geom_ribbon(alpha=0.2) +
    geom_line(aes(y=tpr)) +
    ggtitle(paste0("ROC Curve w/ AUC=", auc))



```

